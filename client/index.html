<!DOCTYPE html>
<html lang="en" ng-app="datahereApp">

<head>
  <title>Data Here</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/bootstrap-responsive.min.css">
  <style>
    body {
      padding-top: 60px;
    }
    /*html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}*/

    #map-canvas {
      width: 100%;
      /*width:600px;*/

      height: 200px;
    }
    #autocomplete {
      width: 100%;
    }
  </style>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
  <script type="text/javascript">
    var sources = [];

    // sources[sources.length] = {
    //   name: "Commonwealth Electoral Divisions"
    //   ,url_name: "federal-electoral-boundaries"
    //   ,wms_url: "http://nationalmap.nicta.com.au/proxy/http://geoserver-nm.nicta.com.au/admin_bnds_abs/ows"
    //   ,layer_name: "admin_bnds%3ACED_2011_AUST"};

    sources[sources.length] = {
      name: "MyBroadband",
      url_name: "mybroadband",
      wms_url: "https://programs.communications.gov.au/geoserver/wms",
      layer_name: "MyBroadband_Map"
    };

    var getFeatureInfoParams = [
      "REQUEST=GetFeatureInfo", "SERVICE=WMS", "VERSION=1.1.1", "FEATURE_COUNT=10", "INFO_FORMAT=application/json", "EXCEPTIONS=application%2Fvnd.ogc.se_xml"
    ];

    var map;

    function initialize() {
      var start = new google.maps.LatLng(-31.15535, 142.59933);

      var mapOptions = {
        center: {
          lat: -34.397,
          lng: 150.644
        },
        // center: start,
        zoom: 10,
        mapTypeControl: true,
        panControl: false,
        zoomControl: false,
        streetViewControl: false
      };

      map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);

      // autocomplete = new google.maps.places.Autocomplete(
      //   /** @type {HTMLInputElement} */
      //   (document.getElementById('autocomplete')), {
      //     //types: ['(cities)'],
      //     // componentRestrictions: {
      //     // 'country': 'au'
      //     // }
      //   });

      google.maps.event.addListener(map, 'click', function(event) {
        // GetFeatureInfoXY(event.pixel.x, event.pixel.y)
        GetFeatureInfo(event.latLng);
        marker.setPosition(event.latLng);
      });

      // setTimeout(function() {
      //   GetFeatureInfo(map.getCenter());
      // }, 1000);

      var marker = new google.maps.Marker({
        map: map,
        position: map.getCenter()
      });

      google.maps.event.addListener(marker, 'dragend', function() {
        console.log('marker dragged to ' + marker.getPosition());
        GetFeatureInfo(marker.getPosition());
      });

      // google.maps.event.addListener(autocomplete, 'place_changed', function() {
      //   var place = autocomplete.getPlace();
      //
      //   if (place == null || !place.geometry) {
      //     console.log('ignoring place / empty geometry');
      //     return;
      //   }
      //
      //   marker.setPosition(place.geometry.location);
      //
      //   GetFeatureInfo(place.geometry.location);
      //
      //   // If the place has a geometry, then present it on a map.
      //   if (place.geometry.viewport) {
      //     map.fitBounds(place.geometry.viewport);
      //   }
      //   else {
      //     map.setCenter(place.geometry.location);
      //     map.setZoom(15);
      //   }
      // });
    }

    function GetFeatureInfo(latlng) {
      if (latlng == undefined) {
        console.log('latlng not defined');
        return;
      }
      var lat = latlng.lat();
      var lng = latlng.lng();
      console.log('GetFeatureInfoFromMapBounds lat=' + lat + ' lng=' + lng);

      var bounds = new google.maps.Circle({
        center: latlng,
        radius: 50.0
      }).getBounds();
      var minx = bounds.getSouthWest().lng();
      var miny = bounds.getSouthWest().lat();
      var maxx = bounds.getNorthEast().lng();
      var maxy = bounds.getNorthEast().lat();

      var bbox = minx + "," + miny + "," + maxx + "," + maxy;
      var width = document.getElementById('map-canvas').offsetWidth;
      var height = document.getElementById('map-canvas').offsetHeight;

      var x = Math.floor((lng - bounds.getSouthWest().lng()) * width);
      var y = Math.floor((bounds.getNorthEast().lat() - lat) * height);

      console.log('bbox=' + bbox);
      console.log('width=' + width + ' height=' + height);
      console.log('x=' + x + ' y=' + y);

      for (var i = 0; i < sources.length; i++) {
        source = sources[i];
        console.log("source.name=" + source.name);
        var url = source.wms_url + "?" + getFeatureInfoParams.join("&");
        url += "&layers=" + source.layer_name;
        url += "&query_layers=" + source.layer_name;

        url += '&width=' + width;
        url += '&height=' + height;
        url += '&bbox=' + bbox;
        url += '&x=' + Math.floor(x);
        url += '&y=' + Math.floor(y);

        console.log('url=' + url);
        if (window.XMLHttpRequest) {
          var request = new XMLHttpRequest();
          request.open("GET", url, true);
          request.send();

          request.onreadystatechange = function() {
            console.log('status=' + request.status);
            if (request.readyState == 4 && request.status == 200) {
              document.getElementById('preview').innerHTML = request.responseText;
              // $scope.results[0] = {};
              // $scope.results[0].name = 'foo name';
              // $scope.results[0].properties = {ESA_NAME: 'foo',ESA_DA: 'bar'};
              var json = JSON.parse(request.responseText);
              if (json.type !== "FeatureCollection") {
                console.log("GFI response did not contain FeatureCollection: " + request.responseText);
                return;
              }



            }
          }
        }
      }
    }
  </script>

</head>

<body onload="initialize()" ng-controller="GFICtrl">
  <div class="container">
    <div class="page-header">
      <h1>Data Here</h1>
    </div>
    <div class="row span12">
      <label>See what's on <a href="http://data.gov.au/">data.gov.au</a> at your address.</label>
    </div>

    <div class="row">
      <div class="span12">
        <input id="autocomplete" type="text" ng-autocomplete="result" details="place" options="options" placeholder="Address">
        <!-- <input ng-model="user.place.lat"> -->
        <!-- <input ng-model="user.place.lng"> -->
      </div>
      <button ng-click="search();">Search</button>
    </div>
    <div class="row">
      <div class="span12">
        <div id="map-canvas"></div>
      </div>
    </div>
    <pre id='preview' style='display:none'></pre>
    <div class="row span12">
      <strong>MyBroadband</strong>
    </div>
    <table ng-repeat="result in results" class="table table-striped table-bordered table-condensed table-responsive">
      <thead>
        <tr>
          <th scope="col">Field</th>
          <th scope="col">Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row" class="dataset-label">ESA_NAME</th>
          <td class="dataset-details" property="dc:type">{{result.properties.ESA_NAME}}</td>
        </tr>
        <tr>
          <th scope="row" class="dataset-label">ESA_DA</th>
          <td class="dataset-details" property="dc:type">{{result.properties.ESA_DA}}</td>
        </tr>
        <tr>
          <th scope="row" class="dataset-label">ESA_NAME</th>
          <td class="dataset-details" property="dc:type">UNANDERRA</td>
        </tr>
        <tr>
          <th scope="row" class="dataset-label">ESA_CODE</th>
          <td class="dataset-details" property="dc:language">UNAN</td>
        </tr>
        <tr>
          <th scope="row" class="dataset-label">AVAILABILITY</th>
          <td class="dataset-details" property="dc:language">E</td>
        </tr>
        <tr>
          <th scope="row" class="dataset-label">QUALITY</th>
          <td class="dataset-details" property="dc:language">E</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- <script src="/socket.io/socket.io.js"></script> -->
  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/angular.min.js"></script>
  <script src="/js/ngAutocomplete.js"></script>
  <script src="/js/controller.js"></script>
</body>

</html>
